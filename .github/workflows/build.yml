name: Build Binaries

on:
  push:
    branches: [ "main" ]

jobs:
  # Build and packages all the things
  build-artifacts:
    strategy:
      fail-fast: false
      matrix:
        # For these target platforms
        include:
        - os: macos-11
          deps-script: brew install protobuf
          dist-args: --artifacts=local --target=x86_64-apple-darwin
          install-dist: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/axodotdev/cargo-dist/releases/download/v0.0.7/cargo-dist-installer.sh | sh
        # - os: macos-11
        #   deps-script: brew install protobuf
        #   dist-args: --artifacts=local --target=aarch64-apple-darwin
        #   install-dist: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/axodotdev/cargo-dist/releases/download/v0.0.7/cargo-dist-installer.sh | sh
        - os: ubuntu-20.04
          deps-script: sudo apt-get install -y protobuf-compiler
          dist-args: --artifacts=local --target=x86_64-unknown-linux-gnu
          install-dist: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/axodotdev/cargo-dist/releases/download/v0.0.7/cargo-dist-installer.sh | sh
        - os: windows-2019
          deps-script: choco install protoc
          dist-args: --artifacts=local --target=x86_64-pc-windows-msvc
          install-dist: irm  https://github.com/axodotdev/cargo-dist/releases/download/v0.0.7/cargo-dist-installer.ps1 | iex

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - name: Install deps
        run: ${{ matrix.deps-script }}
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - uses: Swatinem/rust-cache@v2.3.0
        with:
          key: ${{ matrix.target }}
      - name: Install cargo-dist
        run: ${{ matrix.install-dist }}
      - name: Run cargo-dist
        run: cargo dist build
